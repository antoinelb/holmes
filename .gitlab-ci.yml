stages:
  - build
  - static-analysis
  - test
  - deploy

variables:
  UV_CACHE_DIR: .uv-cache
  PIP_CACHE_DIR: .pip-cache

# Cache uv downloads between pipelines
.uv-cache: &uv-cache
  cache:
    key: uv-cache-${CI_COMMIT_REF_SLUG}
    paths:
      - .uv-cache
      - .pip-cache

# Build with dev dependencies (for static analysis and tests)
build-dev:
  stage: build
  image: python:3.13
  <<: *uv-cache
  script:
    - pip install uv
    - uv sync --frozen
  artifacts:
    paths:
      - .venv
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

# Build without dev dependencies (for deployment)
build-prod:
  stage: build
  image: python:3.13
  <<: *uv-cache
  script:
    - pip install uv
    - uv sync --frozen --no-dev
    - uv build
  artifacts:
    paths:
      - .venv
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG

# Static analysis jobs
black:
  stage: static-analysis
  image: python:3.13
  dependencies:
    - build-dev
  script:
    - source .venv/bin/activate
    - black --check src/ tests/
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

ruff:
  stage: static-analysis
  image: python:3.13
  dependencies:
    - build-dev
  script:
    - source .venv/bin/activate
    - ruff check src/ tests/
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

ty:
  stage: static-analysis
  image: python:3.13
  dependencies:
    - build-dev
  script:
    - source .venv/bin/activate
    - ty check src/
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

# Test job
test:
  stage: test
  image: python:3.13
  dependencies:
    - build-dev
  script:
    - source .venv/bin/activate
    - pytest --cov
  coverage: '/TOTAL.*\s+(\d+%)/'
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success

# Deploy job - only runs on tags
deploy:
  stage: deploy
  image: python:3.13
  dependencies:
    - build-prod
  script:
    - pip install uv
    - uv publish
  rules:
    - if: $CI_COMMIT_TAG
